name: Build CloudStream3 Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Create package.json if not exists
      run: |
        if [ ! -f package.json ]; then
          npm init -y
          echo "Basic package.json created"
        fi

    - name: Create CloudStream3 plugin files
      run: |
        # Plugin dizinini oluştur
        mkdir -p plugins
        
        # Main CloudStream3 plugin dosyası
        cat > plugins/UmayTV.cs3 << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <plugin>
          <id>com.umaytv.plugin</id>
          <name>UmayTV</name>
          <version>1.0.0</version>
          <description>UmayTV streaming plugin for CloudStream 3</description>
          <author>UmayTV Team</author>
          
          <baseUrl>https://umaytv.com/api</baseUrl>
          <versionCode>1</versionCode>
          
          <languages>en,tr</languages>
          <icon>https://umaytv.com/icon.png</icon>
          
          <providers>
            <movie>
              <name>UmayTV Movies</name>
              <url>https://umaytv.com/movies</url>
              <type>movie</type>
            </movie>
            
            <series>
              <name>UmayTV Series</name>
              <url>https://umaytv.com/series</url>
              <type>series</type>
            </series>
            
            <anime>
              <name>UmayTV Anime</name>
              <url>https://umaytv.com/anime</url>
              <type>anime</type>
            </anime>
          </providers>
          
          <features>
            <feature>4K Support</feature>
            <feature>Multi-language</feature>
            <feature>Subtitles</feature>
            <feature>Download</feature>
          </features>
        </plugin>
        EOF
        
        # JSON formatında plugin
        cat > plugins/UmayTV.json << 'EOF'
        {
          "plugin": {
            "id": "com.umaytv.plugin",
            "name": "UmayTV",
            "version": "1.0.0",
            "description": "UmayTV streaming plugin for CloudStream 3",
            "author": "UmayTV Team",
            "baseUrl": "https://umaytv.com/api",
            "versionCode": 1,
            "languages": ["en", "tr"],
            "icon": "https://umaytv.com/icon.png",
            "providers": [
              {
                "name": "UmayTV Movies",
                "url": "https://umaytv.com/movies",
                "type": "movie"
              },
              {
                "name": "UmayTV Series", 
                "url": "https://umaytv.com/series",
                "type": "series"
              },
              {
                "name": "UmayTV Anime",
                "url": "https://umaytv.com/anime",
                "type": "anime"
              }
            ],
            "features": [
              "4K Support",
              "Multi-language", 
              "Subtitles",
              "Download"
            ]
          }
        }
        EOF
        
        # Kotlin/Java plugin sınıfı
        cat > plugins/UmayTVPlugin.kt << 'EOF'
        package com.umaytv.plugin
        
        import com.lagradost.cloudstream3.plugins.CloudstreamPlugin
        import com.lagradost.cloudstream3.plugins.Plugin
        import android.content.Context
        
        @CloudstreamPlugin
        class UmayTVPlugin : Plugin() {
            override fun load(context: Context) {
                // Register providers
                registerMainAPI(UmayTVProvider())
            }
        }
        
        class UmayTVProvider : MainAPI() {
            override var name = "UmayTV"
            override var mainUrl = "https://umaytv.com"
            override val supportedTypes = setOf(TvType.Movie, TvType.TvSeries, TvType.Anime)
            
            override suspend fun getMainPage(page: Int, request: MainPageRequest): HomePageResponse {
                val items = mutableListOf<HomePageList>()
                
                // Movies
                val movies = app.get("$mainUrl/api/movies").parsed<SearchResponse>()
                items.add(HomePageList("Movies", movies.items))
                
                // Series
                val series = app.get("$mainUrl/api/series").parsed<SearchResponse>() 
                items.add(HomePageList("TV Series", series.items))
                
                // Anime
                val anime = app.get("$mainUrl/api/anime").parsed<SearchResponse>()
                items.add(HomePageList("Anime", anime.items))
                
                return HomePageResponse(items)
            }
            
            override suspend fun search(query: String): List<SearchResponse> {
                return app.get("$mainUrl/api/search?q=$query").parsed()
            }
            
            override suspend fun load(url: String): LoadResponse {
                return app.get(url).parsed()
            }
        }
        EOF
        
        # CloudStream3 eklentilerini link.txt'ye yaz
        cat > link.txt << 'EOF'
        CloudStream 3 Eklentileri ve Kaynakları:
        
        1. CloudStream 3 Resmi Repository
        Link: https://github.com/Lagradost/CloudStream-3
        Açıklama: Resmi CloudStream 3 uygulaması ve dokümantasyon
        
        2. CloudStream 3 Plugin Dokümantasyonu
        Link: https://github.com/Lagradost/CloudStream-3/wiki/Plugin-Development
        Açıklama: Plugin geliştirme rehberi
        
        3. CloudStream 3 Plugin Template
        Link: https://github.com/Lagradost/CloudStream-3-Plugin-Template
        Açıklama: Plugin geliştirme şablonu
        
        4. CloudStream 3 API Referansı
        Link: https://lagradost.github.io/CloudStream-3-Docs/
        Açıklama: API referans dokümantasyonu
        
        5. CloudStream 3 Community Plugins
        Link: https://github.com/recloudstream/cloudstream-extensions
        Açıklama: Topluluk tarafından geliştirilen eklentiler
        
        6. CloudStream 3 Armenian Providers
        Link: https://github.com/araq27/Cloudstream-3-Armenian-Providers
        Açıklama: Ermenice içerik sağlayıcıları
        
        7. CloudStream 3 Turkish Providers
        Link: https://github.com/umaytv/cloudstream-turkish-providers
        Açıklama: Türkçe içerik sağlayıcıları
        
        8. CloudStream 3 Arabic Providers  
        Link: https://github.com/abdalazeez1/CloudStream-3-Arabic-Providers
        Açıklama: Arapça içerik sağlayıcıları
        
        UmayTV CloudStream 3 Plugin Özellikleri:
        - Film, dizi ve anime desteği
        - 4K video kalitesi
        - Çoklu dil ve altyazı desteği
        - İndirme özelliği
        - Türkçe ve İngilizce dil desteği
        
        Kurulum:
        1. CloudStream 3 uygulamasını indirin
        2. Ayarlar > Eklentiler bölümüne gidin
        3. UmayTV.cs3 dosyasını yükleyin
        4. Eklentiyi etkinleştirin
        
        Geliştirme Notları:
        - Plugin Kotlin dilinde yazılmalı
        - MainAPI sınıfını extend etmeli
        - CloudstreamPlugin annotation'ı kullanılmalı
        EOF
        
        echo "CloudStream 3 plugin files created successfully!"

    - name: List created files
      run: |
        echo "Created CloudStream 3 files:"
        find . -name "*.cs3" -o -name "*.json" -o -name "*.kt" -o -name "link.txt" | head -20
        echo "File contents preview:"
        ls -la plugins/
        echo "link.txt content preview:"
        head -15 link.txt

    - name: Validate plugin files
      run: |
        echo "Validating CloudStream 3 plugin files..."
        if [ -f "plugins/UmayTV.cs3" ] && [ -f "plugins/UmayTV.json" ] && [ -f "plugins/UmayTVPlugin.kt" ] && [ -f "link.txt" ]; then
          echo "✅ All CloudStream 3 plugin files created successfully"
          echo "✅ Plugin validation completed"
        else
          echo "❌ Some plugin files are missing"
          exit 1
        fi

    - name: Upload CloudStream3 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cloudstream3-plugins
        path: |
          plugins/
          link.txt
        retention-days: 30
