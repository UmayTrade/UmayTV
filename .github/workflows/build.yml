name: Build and Deploy

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build Application and Generate CS3
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Create CS3 configuration files
      run: |
        echo "Creating CS3 configuration files..."
        mkdir -p .cs3
        
        # Main CS3 config
        cat > .cs3/config.json << 'EOF'
        {
          "project": {
            "name": "UmayTV",
            "version": "1.0.0",
            "description": "UmayTV Streaming Platform",
            "repository": "https://github.com/UmayTrade/UmayTV"
          },
          "build": {
            "output_dir": "dist",
            "assets_dir": "assets",
            "plugins_config": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/plugins.json"
          },
          "cs3_files": [
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/core.cs3",
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/ui.cs3",
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/player.cs3",
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/analytics.cs3"
          ]
        }
        EOF
        
        # Core CS3 file
        cat > .cs3/core.cs3 << 'EOF'
        {
          "name": "umaytv-core",
          "version": "1.0.0",
          "type": "core",
          "description": "UmayTV Core Functionality",
          "entry_point": "src/main.js",
          "dependencies": [],
          "config": {
            "api_endpoint": "https://api.umay.tv",
            "cdn_url": "https://cdn.umay.tv"
          }
        }
        EOF
        
        # UI CS3 file
        cat > .cs3/ui.cs3 << 'EOF'
        {
          "name": "umaytv-ui",
          "version": "1.0.0",
          "type": "ui",
          "description": "UmayTV User Interface Components",
          "entry_point": "src/ui/components.js",
          "dependencies": ["umaytv-core"],
          "config": {
            "theme": "dark",
            "language": "tr"
          }
        }
        EOF
        
        # Player CS3 file
        cat > .cs3/player.cs3 << 'EOF'
        {
          "name": "umaytv-player",
          "version": "1.0.0",
          "type": "player",
          "description": "UmayTV Video Player Engine",
          "entry_point": "src/player/engine.js",
          "dependencies": ["umaytv-core"],
          "config": {
            "quality": "auto",
            "autoplay": false,
            "subtitles": true
          }
        }
        EOF
        
        # Analytics CS3 file
        cat > .cs3/analytics.cs3 << 'EOF'
        {
          "name": "umaytv-analytics",
          "version": "1.0.0",
          "type": "analytics",
          "description": "UmayTV Analytics System",
          "entry_point": "src/analytics/tracker.js",
          "dependencies": ["umaytv-core"],
          "config": {
            "track_events": true,
            "user_analytics": true,
            "performance_metrics": true
          }
        }
        EOF
        
        echo "âœ… CS3 files created successfully"
        ls -la .cs3/

    - name: Create plugins.json with CS3 URLs
      run: |
        echo "Creating plugins.json with CS3 file URLs..."
        
        cat > plugins.json << 'EOF'
        {
          "name": "UmayTV Plugins",
          "version": "1.0.0",
          "repository": "https://github.com/UmayTrade/UmayTV",
          "plugins": [
            {
              "id": "umaytv-core",
              "name": "UmayTV Core",
              "version": "1.0.0",
              "description": "Core functionality for UmayTV platform",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/core.cs3",
              "enabled": true,
              "dependencies": []
            },
            {
              "id": "umaytv-ui",
              "name": "UmayTV UI",
              "version": "1.0.0",
              "description": "User interface components and themes",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/ui.cs3",
              "enabled": true,
              "dependencies": ["umaytv-core"]
            },
            {
              "id": "umaytv-player",
              "name": "UmayTV Player",
              "version": "1.0.0",
              "description": "Video player engine with multiple codec support",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/player.cs3",
              "enabled": true,
              "dependencies": ["umaytv-core"]
            },
            {
              "id": "umaytv-analytics",
              "name": "UmayTV Analytics",
              "version": "1.0.0",
              "description": "User analytics and tracking system",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/analytics.cs3",
              "enabled": true,
              "dependencies": ["umaytv-core"]
            }
          ],
          "config": {
            "auto_update": true,
            "cache_plugins": true,
            "log_level": "info"
          }
        }
        EOF
        
        echo "âœ… plugins.json created successfully"

    - name: Create repo.json with plugins.json URL
      run: |
        echo "Creating repo.json..."
        
        cat > repo.json << 'EOF'
        {
          "name": "UmayTV Repository",
          "version": "1.0.0",
          "description": "Official UmayTV plugins and components repository",
          "url": "https://github.com/UmayTrade/UmayTV",
          "plugins_config": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/plugins.json",
          "cs3_config": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/config.json",
          "last_updated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
          "plugins_count": 4,
          "categories": ["core", "ui", "player", "analytics"]
        }
        EOF
        
        echo "âœ… repo.json created successfully"

    - name: Verify all files exist
      run: |
        echo "=== Verifying generated files ==="
        echo "Current directory: $(pwd)"
        ls -la
        
        echo "=== CS3 files ==="
        ls -la .cs3/
        
        echo "=== JSON files ==="
        ls -la *.json
        
        # Count files
        echo "CS3 files count: $(ls -1 .cs3/ | wc -l)"
        echo "JSON files count: $(ls -1 *.json 2>/dev/null | wc -l || echo 0)"

    - name: Upload all artifacts
      uses: actions/upload-artifact@v4
      with:
        name: umaytv-configs
        path: |
          plugins.json
          repo.json
          .cs3/
        retention-days: 7

  validate:
    name: Validate Files
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate JSON files
      run: |
        echo "Validating JSON files..."
        
        # Install jq for JSON validation
        sudo apt-get update && sudo apt-get install -y jq
        
        # Validate plugins.json
        if [ -f "plugins.json" ]; then
          jq empty plugins.json && echo "âœ… plugins.json is valid JSON" || echo "âŒ plugins.json is invalid JSON"
        else
          echo "âŒ plugins.json not found"
        fi
        
        # Validate repo.json
        if [ -f "repo.json" ]; then
          jq empty repo.json && echo "âœ… repo.json is valid JSON" || echo "âŒ repo.json is invalid JSON"
        else
          echo "âŒ repo.json not found"
        fi
        
        # Validate CS3 files
        if [ -d ".cs3" ]; then
          for cs3_file in .cs3/*.cs3 .cs3/*.json; do
            if [ -f "$cs3_file" ]; then
              jq empty "$cs3_file" && echo "âœ… $cs3_file is valid JSON" || echo "âŒ $cs3_file is invalid JSON"
            fi
          done
        else
          echo "âŒ .cs3 directory not found"
        fi

  deploy:
    name: Deploy Configuration Files
    runs-on: ubuntu-latest
    needs: [build, validate]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: umaytv-configs
        path: ./

    - name: Verify downloaded files
      run: |
        echo "=== Downloaded files ==="
        ls -la
        echo "=== Downloaded CS3 files ==="
        ls -la .cs3/
        
        # Verify file counts
        echo "Downloaded JSON files: $(ls -1 *.json 2>/dev/null | wc -l || echo 0)"
        echo "Downloaded CS3 files: $(ls -1 .cs3/* 2>/dev/null | wc -l || echo 0)"

    - name: Setup Git Identity
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add and Commit files
      run: |
        echo "Adding generated files to git..."
        
        # Add all generated files
        git add plugins.json repo.json .cs3/ || true
        
        # Check if there are changes
        if ! git diff --staged --quiet; then
          echo "Changes detected, committing..."
          git commit -m "chore: auto-generate CS3 configs and plugins [skip ci]"
          echo "âœ… Files committed successfully"
        else
          echo "âœ… No changes to commit - files are up to date"
        fi

    - name: Push changes
      run: |
        echo "Pushing changes to repository..."
        git push origin main
        echo "âœ… Changes pushed successfully"

    - name: Display final URLs
      run: |
        echo ""
        echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "====================================="
        echo ""
        echo "ğŸ“ CONFIGURATION FILES:"
        echo "ğŸ“„ plugins.json: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/plugins.json"
        echo "ğŸ  repo.json: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/repo.json"
        echo "âš™ï¸  CS3 Config: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/config.json"
        echo ""
        echo "ğŸ”§ CS3 PLUGIN FILES:"
        echo "ğŸ”§ Core: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/core.cs3"
        echo "ğŸ¨ UI: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/ui.cs3"
        echo "ğŸ“º Player: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/player.cs3"
        echo "ğŸ“Š Analytics: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/analytics.cs3"
        echo ""
        echo "âœ… All configuration files are now live and accessible!"
