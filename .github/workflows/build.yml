name: Build DMAX CloudStream3 Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-dmax-cs3:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Find and process DMAX plugin files
      run: |
        echo "DMAX dizinindeki dosyalarƒ± bulma..."
        find DMax -type f -name "*.kt" -o -name "*.java" -o -name "*.json" -o -name "*.xml" | head -20
        
        # DMAX dizini var mƒ± kontrol et
        if [ -d "DMax" ]; then
          echo "‚úÖ DMAX dizini bulundu"
          
          # DMAX dosyalarƒ±nƒ± listele
          echo "üìÅ DMAX dosyalarƒ±:"
          ls -la DMax/
          
          # T√ºm DMAX dosyalarƒ±nƒ± birle≈ütirerek CS3 olu≈ütur
          mkdir -p dist/plugins
          
          # Kotlin dosyalarƒ±nƒ± birle≈ütir
          if find DMax -name "*.kt" | grep -q .; then
            echo "üìù Kotlin dosyalarƒ± birle≈ütiriliyor..."
            find DMax -name "*.kt" -exec cat {} \; > dist/plugins/dmax_combined.kt
          fi
          
          # Java dosyalarƒ±nƒ± birle≈ütir
          if find DMax -name "*.java" | grep -q .; then
            echo "üìù Java dosyalarƒ± birle≈ütiriliyor..."
            find DMax -name "*.java" -exec cat {} \; > dist/plugins/dmax_combined.java
          fi
          
          # JSON dosyalarƒ±nƒ± birle≈ütir
          if find DMax -name "*.json" | grep -q .; then
            echo "üìù JSON dosyalarƒ± birle≈ütiriliyor..."
            find DMax -name "*.json" -exec cat {} \; > dist/plugins/dmax_combined.json
          fi
          
        else
          echo "‚ùå DMAX dizini bulunamadƒ±, √∂rnek plugin olu≈üturuluyor..."
          mkdir -p DMax
        fi

    - name: Create CloudStream3 plugin from DMAX files
      run: |
        # DMAX plugin i√ßin CS3 manifest dosyasƒ± olu≈ütur
        cat > dist/plugins/dmax.cs3 << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <plugin>
            <id>com.umaytv.dmax</id>
            <name>DMAX T√ºrkiye</name>
            <version>1.0.0</version>
            <versionCode>1</versionCode>
            <description>DMAX T√ºrkiye i√ßerikleri i√ßin CloudStream 3 eklentisi</description>
            <author>UmayTV</author>
            <website>https://github.com/UmayTrade/UmayTV</website>
            
            <baseUrl>https://www.dmax.com.tr</baseUrl>
            <lang>tr</lang>
            
            <permissions>
                <permission>INTERNET</permission>
                <permission>ACCESS_NETWORK_STATE</permission>
            </permissions>
            
            <providers>
                <provider>
                    <name>DMAX Movies</name>
                    <type>movie</type>
                    <url>https://www.dmax.com.tr/filmler</url>
                </provider>
                <provider>
                    <name>DMAX Series</name>
                    <type>series</type>
                    <url>https://www.dmax.com.tr/diziler</url>
                </provider>
                <provider>
                    <name>DMAX Documentaries</name>
                    <type>documentary</type>
                    <url>https://www.dmax.com.tr/belgeseller</url>
                </provider>
            </providers>
            
            <features>
                <feature>HD Quality</feature>
                <feature>Turkish Content</feature>
                <feature>Multiple Categories</feature>
                <feature>Search Function</feature>
            </features>
            
            <buildInfo>
                <source>DMax/</source>
                <buildDate>$(date +'%Y-%m-%d %H:%M:%S')</buildDate>
                <commitHash>${{ github.sha }}</commitHash>
            </buildInfo>
        </plugin>
        EOF

        # Plugin yapƒ±landƒ±rma dosyasƒ±
        cat > dist/plugins/dmax_plugin.json << 'EOF'
        {
          "plugin": {
            "id": "com.umaytv.dmax",
            "name": "DMAX T√ºrkiye",
            "version": "1.0.0",
            "versionCode": 1,
            "description": "DMAX T√ºrkiye i√ßerikleri i√ßin CloudStream 3 eklentisi",
            "author": "UmayTV",
            "website": "https://github.com/UmayTrade/UmayTV",
            "baseUrl": "https://www.dmax.com.tr",
            "language": "tr",
            "permissions": [
              "INTERNET",
              "ACCESS_NETWORK_STATE"
            ],
            "providers": [
              {
                "name": "DMAX Movies",
                "type": "movie",
                "url": "https://www.dmax.com.tr/filmler"
              },
              {
                "name": "DMAX Series", 
                "type": "series",
                "url": "https://www.dmax.com.tr/diziler"
              },
              {
                "name": "DMAX Documentaries",
                "type": "documentary", 
                "url": "https://www.dmax.com.tr/belgeseller"
              }
            ],
            "features": [
              "HD Quality",
              "Turkish Content",
              "Multiple Categories", 
              "Search Function"
            ]
          }
        }
        EOF

        # DMAX √∂zel build script'i
        cat > dist/plugins/build_dmax.sh << 'EOF'
        #!/bin/bash
        # DMAX CloudStream3 Plugin Build Script
        
        echo "üî® DMAX Plugin Build Started..."
        echo "üìÅ Source Directory: DMax/"
        echo "üéØ Target: CloudStream3 Plugin"
        
        # Kotlin dosyalarƒ±nƒ± kontrol et
        if [ -f "dmax_combined.kt" ]; then
            echo "‚úÖ Kotlin source found: $(wc -l < dmax_combined.kt) lines"
        fi
        
        if [ -f "dmax_combined.java" ]; then
            echo "‚úÖ Java source found: $(wc -l < dmax_combined.java) lines"
        fi
        
        if [ -f "dmax_combined.json" ]; then
            echo "‚úÖ JSON config found: $(wc -l < dmax_combined.json) lines"
        fi
        
        echo "üì¶ Plugin Files:"
        ls -la *.cs3 *.json *.kt *.java 2>/dev/null || echo "No build files found"
        
        echo "üèÅ DMAX Plugin Build Completed!"
        EOF

        chmod +x dist/plugins/build_dmax.sh

    - name: Create plugin information file
      run: |
        # Plugin bilgi dosyasƒ± olu≈ütur
        cat > dist/plugins/PLUGIN_INFO.md << 'EOF'
        # DMAX CloudStream 3 Plugin
        
        ## Plugin Bilgileri
        - **ID**: com.umaytv.dmax
        - **Name**: DMAX T√ºrkiye
        - **Version**: 1.0.0
        - **Author**: UmayTV
        - **Source**: DMax/ directory
        
        ## √ñzellikler
        - DMAX T√ºrkiye i√ßerikleri
        - Film ve dizi desteƒüi
        - T√ºrk√ße dil desteƒüi
        - Arama fonksiyonu
        - HD kalite
        
        ## Kurulum
        1. CloudStream 3 uygulamasƒ±nƒ± a√ßƒ±n
        2. Ayarlar > Eklentiler b√∂l√ºm√ºne gidin
        3. `dmax.cs3` dosyasƒ±nƒ± y√ºkleyin
        4. Eklentiyi etkinle≈ütirin
        
        ## Geli≈ütirme
        Kaynak kodlar: `DMax/` dizini
        
        ## Build Bilgileri
        - Build Date: $(date)
        - Commit: ${{ github.sha }}
        - Repository: ${{ github.repository }}
        EOF

    - name: Generate file list and checksums
      run: |
        echo "üìã Generated Files:"
        find dist/plugins -type f | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
          lines=$(wc -l < "$file" 2>/dev/null || echo "N/A")
          echo "  üìÑ $file (Size: ${size} bytes, Lines: ${lines})"
        done
        
        # Checksum olu≈ütur
        cd dist/plugins
        find . -type f -name "*.cs3" -o -name "*.json" -o -name "*.kt" -o -name "*.java" | while read file; do
          if command -v md5sum >/dev/null; then
            checksum=$(md5sum "$file")
          elif command -v md5 >/dev/null; then
            checksum=$(md5 -q "$file")
          else
            checksum="N/A"
          fi
          echo "üîí $file - MD5: $checksum"
        done > checksums.txt
        cd ../..

    - name: Upload DMAX CS3 plugin artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dmax-cloudstream3-plugin
        path: |
          dist/plugins/
          DMax/
        retention-days: 30

    - name: Create release summary
      run: |
        echo "## DMAX CloudStream 3 Plugin Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Generated Files:" >> $GITHUB_STEP_SUMMARY
        echo "- **dmax.cs3** - CloudStream3 plugin manifest" >> $GITHUB_STEP_SUMMARY
        echo "- **dmax_plugin.json** - Plugin configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **PLUGIN_INFO.md** - Installation guide" >> $GITHUB_STEP_SUMMARY
        echo "- **build_dmax.sh** - Build script" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîß Source Directory:" >> $GITHUB_STEP_SUMMARY
        echo "- **DMax/** - Original plugin source files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì• Download:" >> $GITHUB_STEP_SUMMARY
        echo "Artifacts b√∂l√ºm√ºnden `dmax-cloudstream3-plugin` indirilebilir." >> $GITHUB_STEP_SUMMARY
