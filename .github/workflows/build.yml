name: Build and Deploy

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  generate-configs:
    name: Generate CS3 Configs
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create CS3 configuration files
      run: |
        echo "Creating CS3 configuration files..."
        mkdir -p .cs3
        
        # Main CS3 config
        cat > .cs3/config.json << 'EOF'
        {
          "project": {
            "name": "UmayTV",
            "version": "1.0.0",
            "description": "UmayTV Streaming Platform",
            "repository": "https://github.com/UmayTrade/UmayTV"
          },
          "build": {
            "output_dir": "dist",
            "assets_dir": "assets",
            "plugins_config": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/plugins.json"
          },
          "cs3_files": [
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/core.cs3",
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/ui.cs3",
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/player.cs3",
            "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/analytics.cs3"
          ]
        }
        EOF
        
        # Core CS3 file
        cat > .cs3/core.cs3 << 'EOF'
        {
          "name": "umaytv-core",
          "version": "1.0.0",
          "type": "core",
          "description": "UmayTV Core Functionality",
          "entry_point": "src/main.js",
          "dependencies": [],
          "config": {
            "api_endpoint": "https://api.umay.tv",
            "cdn_url": "https://cdn.umay.tv"
          }
        }
        EOF
        
        # UI CS3 file
        cat > .cs3/ui.cs3 << 'EOF'
        {
          "name": "umaytv-ui",
          "version": "1.0.0",
          "type": "ui",
          "description": "UmayTV User Interface Components",
          "entry_point": "src/ui/components.js",
          "dependencies": ["umaytv-core"],
          "config": {
            "theme": "dark",
            "language": "tr"
          }
        }
        EOF
        
        # Player CS3 file
        cat > .cs3/player.cs3 << 'EOF'
        {
          "name": "umaytv-player",
          "version": "1.0.0",
          "type": "player",
          "description": "UmayTV Video Player Engine",
          "entry_point": "src/player/engine.js",
          "dependencies": ["umaytv-core"],
          "config": {
            "quality": "auto",
            "autoplay": false,
            "subtitles": true
          }
        }
        EOF
        
        # Analytics CS3 file
        cat > .cs3/analytics.cs3 << 'EOF'
        {
          "name": "umaytv-analytics",
          "version": "1.0.0",
          "type": "analytics",
          "description": "UmayTV Analytics System",
          "entry_point": "src/analytics/tracker.js",
          "dependencies": ["umaytv-core"],
          "config": {
            "track_events": true,
            "user_analytics": true,
            "performance_metrics": true
          }
        }
        EOF
        
        echo "‚úÖ CS3 files created successfully"
        ls -la .cs3/

    - name: Create plugins.json with CS3 URLs
      run: |
        echo "Creating plugins.json with CS3 file URLs..."
        
        cat > plugins.json << 'EOF'
        {
          "name": "UmayTV Plugins",
          "version": "1.0.0",
          "repository": "https://github.com/UmayTrade/UmayTV",
          "plugins": [
            {
              "id": "umaytv-core",
              "name": "UmayTV Core",
              "version": "1.0.0",
              "description": "Core functionality for UmayTV platform",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/core.cs3",
              "enabled": true,
              "dependencies": []
            },
            {
              "id": "umaytv-ui",
              "name": "UmayTV UI",
              "version": "1.0.0",
              "description": "User interface components and themes",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/ui.cs3",
              "enabled": true,
              "dependencies": ["umaytv-core"]
            },
            {
              "id": "umaytv-player",
              "name": "UmayTV Player",
              "version": "1.0.0",
              "description": "Video player engine with multiple codec support",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/player.cs3",
              "enabled": true,
              "dependencies": ["umaytv-core"]
            },
            {
              "id": "umaytv-analytics",
              "name": "UmayTV Analytics",
              "version": "1.0.0",
              "description": "User analytics and tracking system",
              "author": "UmayTrade",
              "cs3_url": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/analytics.cs3",
              "enabled": true,
              "dependencies": ["umaytv-core"]
            }
          ],
          "config": {
            "auto_update": true,
            "cache_plugins": true,
            "log_level": "info"
          }
        }
        EOF
        
        echo "‚úÖ plugins.json created successfully"

    - name: Create repo.json with plugins.json URL
      run: |
        echo "Creating repo.json..."
        
        cat > repo.json << 'EOF'
        {
          "name": "UmayTV Repository",
          "version": "1.0.0",
          "description": "Official UmayTV plugins and components repository",
          "url": "https://github.com/UmayTrade/UmayTV",
          "plugins_config": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/plugins.json",
          "cs3_config": "https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/config.json",
          "last_updated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
          "plugins_count": 4,
          "categories": ["core", "ui", "player", "analytics"]
        }
        EOF
        
        echo "‚úÖ repo.json created successfully"

    - name: Verify all files exist
      run: |
        echo "=== Verifying generated files ==="
        echo "Current directory: $(pwd)"
        ls -la
        
        echo "=== CS3 files ==="
        ls -la .cs3/
        
        echo "=== JSON files ==="
        ls -la *.json
        
        # Count files
        echo "CS3 files count: $(ls -1 .cs3/ | wc -l)"
        echo "JSON files count: $(ls -1 *.json 2>/dev/null | wc -l || echo 0)"

    - name: Upload CS3 files artifact
      uses: actions/upload-artifact@v4
      with:
        name: cs3-files
        path: .cs3/
        retention-days: 7

    - name: Upload JSON files artifact
      uses: actions/upload-artifact@v4
      with:
        name: json-configs
        path: |
          plugins.json
          repo.json
        retention-days: 7

  validate:
    name: Validate Files
    runs-on: ubuntu-latest
    needs: generate-configs
    
    steps:
    - name: Download CS3 files
      uses: actions/download-artifact@v4
      with:
        name: cs3-files
        path: .cs3

    - name: Download JSON configs
      uses: actions/download-artifact@v4
      with:
        name: json-configs
        path: ./

    - name: Verify downloaded files
      run: |
        echo "=== Downloaded files structure ==="
        ls -la
        echo "=== CS3 files ==="
        ls -la .cs3/ || echo "CS3 directory not found"
        
        # Check specific files
        [ -f "plugins.json" ] && echo "‚úÖ plugins.json exists" || echo "‚ùå plugins.json missing"
        [ -f "repo.json" ] && echo "‚úÖ repo.json exists" || echo "‚ùå repo.json missing"
        [ -d ".cs3" ] && echo "‚úÖ .cs3 directory exists" || echo "‚ùå .cs3 directory missing"

    - name: Validate JSON files
      run: |
        echo "Validating JSON files..."
        
        # Install jq for JSON validation
        sudo apt-get update && sudo apt-get install -y jq
        
        # Validate plugins.json
        if [ -f "plugins.json" ]; then
          jq empty plugins.json && echo "‚úÖ plugins.json is valid JSON" || echo "‚ùå plugins.json is invalid JSON"
        else
          echo "‚ùå plugins.json not found"
        fi
        
        # Validate repo.json
        if [ -f "repo.json" ]; then
          jq empty repo.json && echo "‚úÖ repo.json is valid JSON" || echo "‚ùå repo.json is invalid JSON"
        else
          echo "‚ùå repo.json not found"
        fi
        
        # Validate CS3 files
        if [ -d ".cs3" ]; then
          for cs3_file in .cs3/*.cs3 .cs3/*.json; do
            if [ -f "$cs3_file" ]; then
              jq empty "$cs3_file" && echo "‚úÖ $cs3_file is valid JSON" || echo "‚ùå $cs3_file is invalid JSON"
            fi
          done
        else
          echo "‚ùå .cs3 directory not found"
        fi

  deploy:
    name: Deploy Configuration Files
    runs-on: ubuntu-latest
    needs: [generate-configs, validate]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download CS3 files
      uses: actions/download-artifact@v4
      with:
        name: cs3-files
        path: .cs3

    - name: Download JSON configs
      uses: actions/download-artifact@v4
      with:
        name: json-configs
        path: ./

    - name: Verify all files before commit
      run: |
        echo "=== Files ready for commit ==="
        ls -la
        echo "=== CS3 files ==="
        ls -la .cs3/
        
        # Verify we have all required files
        REQUIRED_FILES=("plugins.json" "repo.json" ".cs3/config.json" ".cs3/core.cs3" ".cs3/ui.cs3" ".cs3/player.cs3" ".cs3/analytics.cs3")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file missing"
          fi
        done

    - name: Setup Git Identity
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add generated files to git
      run: |
        echo "Adding generated files to git..."
        
        # Check current git status
        echo "=== Current git status ==="
        git status --porcelain
        
        # Add all generated files
        git add plugins.json repo.json .cs3/
        
        echo "=== Files after git add ==="
        git status --porcelain

    - name: Commit files
      run: |
        echo "Committing generated files..."
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "‚úÖ No changes to commit - files are up to date"
        else
          git commit -m "chore: auto-generate CS3 configs and plugins [skip ci]"
          echo "‚úÖ Files committed successfully"
        fi

    - name: Push changes
      run: |
        echo "Pushing changes to repository..."
        git push
        echo "‚úÖ Changes pushed successfully"

    - name: Display final URLs
      run: |
        echo ""
        echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "====================================="
        echo ""
        echo "üìÅ CONFIGURATION FILES:"
        echo "üìÑ plugins.json: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/plugins.json"
        echo "üè† repo.json: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/repo.json"
        echo "‚öôÔ∏è  CS3 Config: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/config.json"
        echo ""
        echo "üîß CS3 PLUGIN FILES:"
        echo "üîß Core: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/core.cs3"
        echo "üé® UI: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/ui.cs3"
        echo "üì∫ Player: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/player.cs3"
        echo "üìä Analytics: https://raw.githubusercontent.com/UmayTrade/UmayTV/main/.cs3/analytics.cs3"
        echo ""
        echo "‚úÖ All configuration files are now live and accessible!"
